CREATE MATERIALIZED VIEW grade5 AS SELECT * FROM CourseRegistrations WHERE Grade >= 5;
CREATE INDEX grade5_sr_idx ON grade5 (StudentRegistrationId);
CREATE MATERIALIZED VIEW Active AS (SELECT srd.StudentId, srd.DegreeId, srd.StudentRegistrationId, SUM(cr.Grade*Courses.ECTS)/SUM(Courses.ECTS) AS gpa FROM StudentRegistrationsToDegrees as srd INNER JOIN Degrees ON srd.DegreeId = Degrees.DegreeId INNER JOIN CourseRegistrations AS cr ON srd.StudentRegistrationId = cr.StudentRegistrationId INNER JOIN CourseOffers as co ON cr.CourseOfferId = co.CourseOfferId INNER JOIN Courses ON co.CourseId = Courses.CourseId WHERE cr.Grade >= 5 GROUP BY srd.StudentId, srd.DegreeId, Degrees.TotalECTS, srd.StudentRegistrationId HAVING SUM(Courses.ECTS) < Degrees.TotalECTS OR SUM(Courses.ECTS) IS NULL);
